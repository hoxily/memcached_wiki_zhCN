# 新硬件

亮闪闪

2011年8月22日更新

* 硬件需求
    * CPU需求
    * 内存需求
* 硬件布局
    * 在Web服务器上运行Memcached
    * 在数据库服务器上运行Memcached
    * 使用专用的主机
    * 容量规划
    * 网络

## 硬件需求

Memcached对硬件的需求很容易指出。

简而言之，它对CPU的使用一般比较低，消耗尽可能多的你给它的内存，网络使用率则从轻微到中等不等，根据你存储的项的平均大小。

## CPU需求

Memcached是典型的对CPU需求不高，因为它的目标正是快速响应。

Memcached是多线程的，默认有4个工作线程。

这并不是说你需要运行100个核心才能让它满足你的要求。

如果你打算依赖memcached的多线程，你将会知道的。

对于常规用途，CPU任何部分通常都是足够的。

## 内存需求

memcached的要点在于如何将来自多个主机的内存区块缝补起来，让你的应用能把它当成一个大的内存区块。

内存越多越好。

但是不要抽掉那些从memcached中受益的其他服务的内存。

让每个memcached服务器拥有大致相同的可用内存是有益的。

集群的一致性意味着你能简单地添力和减少服务器而不用关心它独有的“体重”，否则会使某台服务器更受伤当它“瘦了”。

### 避免虚拟内存交换

分配给一台memcached服务器足够的并且多那么百分之几的内存。不要过度申请内存然后寄希望于虚拟内存交换能拯救你。性能将会非常非常低下。如果你的服务器使用虚拟内存交换，那么你需要小心地监视它。如果有必需得调整。

高速内存是否有必要？

不是非常必要，不必要。

使用那些额外高速的内存不太可能会让你得到可见的好处，除非你把极高的读取流量分配给memcached。

## 硬件布局

### 在Web服务器上运行Memcached

一个容易的布局是使用Web服务器或者电脑节点上的空闲内存。如果你购买了一台4G内存的Web服务器，但是你的应用以及操作系统仅仅使用了最多2G内存，那么你可以给memcached实例分配1.5G或更多的内存。

这是对内存分布更稀疏的一种平衡，如此则在丢失一台Web服务器时不致造成太多疼痛。

警告存在的额外的维护，并且仔细看着你的应用的多重获取（multi-get）使用，因为它能终结访问你列表中的每个memcached。如果你的应用会内存泄漏，那么你会冒着将一台机器推入虚拟内存交换甚至杀死memcached的风险。通常运行一台只有很小虚拟内存交换的主机会是一个好主意，甚至根本没有虚拟内存交换。让一个活动的服务挂掉比让它陷入焦油坑要好。

### 在数据库服务器上运行Memcached

烂主意。

别这么做。

如果你有一台数据库主机，给它尽可能多的内存。

当缓存未命中发生时，你就能从保证你的索引与数据已经在内存中获益。

### 使用专用的主机

使用专用的硬件给memcached意味着你不必担心机器上的其他程序干扰memcached。你可以在一台主机上安装大量内存（64G以上），然后减少需求内存的机器数量。这样做有一个额外的好处，那就是可以更轻松地扩展大量内存空间。出问题时，你可以增加特殊配置的机器来吐出内存，而不用增加可能会闲置的Web服务器。这最终有许多警告。

你越是压缩memcached的集群，你在某台主机挂掉时会感到更加痛苦。

比如说你的缓存命中率为90%。如果你拥有10台memcached服务器，然后其中一台挂掉了，你的命中率可能会降到82%左右。如果缓存命中率从10%跳到18%或者20%，那么这意味着你的后端突然需要处理相比之前2倍的请求。实际上的影响将会变化，因为数据库依然对处理重复的请求相当给力，并且你的典型的缓存未命中将会经常出现在那些数据库无论如何必须查找的项。

依然是两倍！

那么假设你买了一大批拥有144G内存的服务器，但是你只能负担得起其中4台。这时当你丢失一台单独的服务器，25%的缓存消失了，你的命中率将会更加严重地缩水。

### 容量规划

在给予了上述硬件部局的注意事项后，确保你作出良好的容量规划。

了解在你的应用崩溃之前允许多少服务器挂掉。确保你总能有多于这个数量的服务器。

如果你不能卸下memcached实例，那么你就是在保证升级（硬件或软件）以及常规的失败是极度的痛苦。

减少你的痛苦并且早做打算吧。

### 网络

网络需求会因为memcached上的项的平均大小而变化很大。

你的应用应该致力于保持这些项的大小小一些，这样就意味着各个项之间的大小差异能够很好地适应千兆级的交换机之间的上行链路，甚至像干杯那样一口干掉。

绝大部分部署都仅需要较低的网络需求（每个实例小于10Mbps），但是负担沉重的服务的支持会是相当有挑战性。

这就是说，如果你求助于无限带宽或者万兆以太网来连接你的memcached实例，那么你很可能还是将它们摊开些的好。